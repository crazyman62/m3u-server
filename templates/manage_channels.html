{% extends "base.html" %}

{% block content %}
  {# Bulk action form #}
  <form id="bulkActionForm" method="POST" action="{{ url_for('bulk_update_channels') }}">
     <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
     <div class="mb-3 d-flex align-items-center gap-2"> {# Use flexbox for better alignment/spacing #}
        <button type="submit" name="action" value="enable" class="btn btn-success btn-sm">Enable Selected</button>
        <button type="submit" name="action" value="disable" class="btn btn-warning btn-sm">Disable Selected</button>
        {# --- NEW BUTTON --- #}
        <button type="submit" name="action" value="disable_all" id="disableAllBtn" class="btn btn-danger btn-sm ms-auto">Disable ALL Channels</button> {# Added ms-auto to push it right #}
     </div>
     <div class="mb-3"> {# Moved note below buttons #}
        <span class="fst-italic text-muted">(Note: 'Selected' actions apply to rows selected on the *current page*)</span>
     </div>
  </form>

  <table id="channelsTable" class="table table-striped table-hover table-bordered" style="width:100%">
      <thead class="table-light">
          <tr>
              <th><input type="checkbox" id="selectAllCheckbox" title="Select/Deselect All on page"></th> {# Checkbox Column #}
              <th>Name</th>
              <th>Category</th>
              <th>Status</th>
              <th>Actions</th> {# Individual actions #}
          </tr>
      </thead>
      <tbody>
          {# Table body will be populated by DataTables via AJAX #}
      </tbody>
  </table>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // --- Initialize DataTables ---
    const table = $('#channelsTable').DataTable({
        "processing": true, // Show processing indicator
        "serverSide": true, // Enable server-side processing
        "ajax": {
            "url": "{{ url_for('get_channels_data') }}", // URL of the backend API endpoint
            "type": "POST", // Use POST to send parameters
            "data": function ( d ) {
                 // Optional: Add extra data to send to server if needed
                 // d.myKey = "myValue";
                 // Add CSRF token for POST requests if your API endpoint requires it
                 d.csrf_token = "{{ csrf_token() }}";
            },
            "error": function(jqXHR, textStatus, errorThrown) {
                console.error("DataTables Error:", textStatus, errorThrown, jqXHR.responseText);
                alert("Error loading channel data. Please check console for details.");
            }
        },
        "columns": [
            // Define columns corresponding to the data returned from the server
            { "data": "select_ch", "orderable": false, "searchable": false, "width": "1%" }, // Checkbox
            { "data": "name" },        // Channel Name
            { "data": "category" },   // Category
            { "data": "status", "searchable": false },   // Status (formatted on server)
            { "data": "actions", "orderable": false, "searchable": false } // Actions (formatted on server)
        ],
        "order": [
             // Default sort order: Enabled first, then by Name ascending
            [ 3, 'desc' ], // Sort by status column (index 3), descending (Enabled=1 comes first)
            [ 1, 'asc' ]  // Then sort by name column (index 1), ascending
        ],
        "lengthMenu": [
             // Options for number of rows per page
             [25, 50, 100, 200, 400, 600, 1200, 2400, 5000, -1], // Added 2400, 5000, -1 (for All)
             ['25', '50', '100', '200', '400', '600', '1200', '2400', '5000', 'All'] // Added corresponding labels
        ],
        "pageLength": 50, // Default number of rows per page
        "language": { // Optional: Customize text
            "processing": '<div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">Loading...</span></div> Processing...'
        },
        // Make checkboxes work better with DataTables redraws
        "drawCallback": function( settings ) {
            // Re-initialize select-all logic if needed after table redraws
            initializeSelectAll();
            // Re-attach event listeners for toggle buttons if using AJAX toggle
            initializeToggleButtons();
        }
    });

    // --- Checkbox Logic ---
    function initializeSelectAll() {
        // Remove previous listener to avoid duplicates
        $('#selectAllCheckbox').off('change').on('change', function() {
            const isChecked = $(this).prop('checked');
            // Apply to checkboxes only on the current page drawn by DataTables
            table.rows({ page: 'current' }).nodes().to$().find('.channel-checkbox').prop('checked', isChecked);
        });

        // Handle individual checkboxes affecting select-all state (optional)
         // Use delegated event listener attached to the table body
        $('#channelsTable tbody').off('change', '.channel-checkbox').on('change', '.channel-checkbox', function() {
             if (!$(this).prop('checked')) {
                 // If any checkbox on the current page is unchecked, uncheck the select-all
                 $('#selectAllCheckbox').prop('checked', false);
             } else {
                 // Optional: Check if all checkboxes on the current page are checked
                 const allChecked = table.rows({ page: 'current' }).nodes().to$().find('.channel-checkbox:not(:checked)').length === 0;
                 $('#selectAllCheckbox').prop('checked', allChecked);
             }
        });
    }
    initializeSelectAll(); // Initial setup

    // --- Handle Bulk Form Submission ---
    $('#bulkActionForm').on('submit', function(e) {
        const form = this;
        const action = $(document.activeElement).val(); // Get the value of the button clicked

        // --- Confirmation for Disable ALL ---
        if (action === 'disable_all') {
            if (!confirm('Are you sure you want to disable ALL channels? This cannot be easily undone for all channels at once.')) {
                e.preventDefault(); // Stop form submission
                return false;
            }
            // No need to collect IDs for disable_all
            // Remove any potentially leftover hidden inputs before submitting
             $(form).find('input[name="channel_ids"]').remove();
        } else {
            // Original logic for selected items
            // Detach previous hidden inputs if any
            $(form).find('input[name="channel_ids"]').remove();
            // Append selected checkbox values from the *current page*
            table.rows({ page: 'current' }).nodes().to$().find('.channel-checkbox:checked').each(function() {
               $(form).append(
                   $('<input>')
                      .attr('type', 'hidden')
                      .attr('name', 'channel_ids')
                      .val($(this).val())
               );
            });

            const selectedCount = $(form).find('input[name="channel_ids"]').length;
            if (selectedCount === 0) {
                alert("Please select at least one channel for 'Enable Selected' or 'Disable Selected'.");
                e.preventDefault(); // Stop form submission
                return false;
            }
        }
        // Allow form submission for disable_all or if items are selected
    });


    // --- Handle Individual Toggle Actions (AJAX Example) ---
    function initializeToggleButtons() {
         // Use delegated event listener attached to the table body
        $('#channelsTable tbody').off('click', '.toggle-btn').on('click', '.toggle-btn', function (e) {
            e.preventDefault(); // Prevent default if it's inside a form/link
            const button = $(this);
            const channelId = button.data('channel-id');
            const currentStatus = button.text().trim(); // "Enable" or "Disable"

            // Disable button temporarily
            button.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>');

            $.ajax({
                url: `/channel/toggle/${channelId}`, // Use template literal if needed for url_for in JS
                type: 'POST',
                headers: { // Send CSRF token if required by your endpoint
                    'X-CSRFToken': "{{ csrf_token() }}"
                },
                success: function(response) {
                    if (response.status === 'success') {
                        // Optionally redraw the row or the whole table
                        // table.row(button.closest('tr')).invalidate().draw(false); // Invalidate row data
                        table.ajax.reload(null, false); // Reload current page data without resetting paging
                        // Show a success message (e.g., using Bootstrap toasts or simple alert)
                        // Example: $('<div class="alert alert-success alert-dismissible fade show fixed-top m-3" role="alert">Channel status updated!<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>').appendTo('body').delay(3000).fadeOut();
                    } else {
                        alert(`Error: ${response.message || 'Could not toggle status.'}`);
                        // Re-enable button and restore text on error
                         button.prop('disabled', false).text(currentStatus);
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                     console.error("Toggle Error:", textStatus, errorThrown, jqXHR.responseText);
                     alert("An error occurred while toggling status. Check console.");
                     // Re-enable button and restore text on error
                      button.prop('disabled', false).text(currentStatus);
                }
            });
        });
    }
     initializeToggleButtons(); // Initial setup

});
</script>
{% endblock %}